{% extends "base.html" %}

{% block head %}
<style>
    .profile-img-thumbnail{
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 1rem;
    }
    .charity-action-buttons {
        display: flex; /* or display: grid; for grid layout */
        gap: 8px; /* Adjust the gap as needed */
    }

    .charity-action-buttons button {
        flex: 1; /* or use grid-column: span 1; for grid layout */
    }
</style>
{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>

<div id="vue-admin-dashboard" class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">Admin Dashboard</h2>

            <!-- Tab Buttons -->
            {% include 'admin/admin_tabs.html' %}
            

            <!-- Tab Content -->
            <div class="tab-content mt-4">
                <div v-show="activeTab === 'statistics'">{% include 'admin/admin_statistics.html' %}</div>
                <div v-show="activeTab === 'users'">{% include 'admin/user_list_section.html' %}</div>
                <div v-show="activeTab === 'services'">{% include 'admin/service_list_section.html' %}</div>
                <div v-show="activeTab === 'bookings'">{% include 'admin/booking_list_section.html' %}</div>
                <div v-show="activeTab === 'donations'">{% include 'admin/donation_list_section.html' %}</div>
                <div v-show="activeTab === 'charities'">{% include 'admin/charity_list_section.html' %}</div>
                <div v-show="activeTab === 'locations'">{% include 'admin/location_list_section.html' %}</div>
                <div v-show="activeTab === 'payments'">{% include 'admin/payment_list_section.html' %}</div>
                <div v-show="activeTab === 'availabilities'">{% include 'admin/availability_list_section.html' %}</div>
                <div v-show="activeTab === 'contactMessages'">{% include 'admin/contact_message_list_section.html' %}</div>
            </div>
        </div>
    </div>
</div>

<script>
    new Vue({
        el: '#vue-admin-dashboard',
        delimiters: ['${', '}'], // Change Vue delimiters to avoid conflict with Jinja
        data: {
            activeTab: 'statistics',
            userCount: "{{ data.user_count }}", // Static data from Flask
            serviceCount: 0,
            bookingCount: 0,
            donationCount: 0,
            users: [], // Array to hold user data from API
            services: [], // Array to hold service data from API
            bookings: [], // Array to hold service data from API
            donations: [], // Array to hold service data from API
            charities: [], // Array to hold charity data from API
            locations: [], // Array to hold location data from API
            payments: [], // Array to hold payment data from API
            availabilities: [], // Array to hold availability data from API
            contactMessages: [], // Array to hold contact message data from API
            availabilityRules: [],
            globalExclusions: [],
            selectedUser: {
                id: null,
                username: '',
                email: '',
                status: 'active',
                role: 'user',
                first_name: '',
                last_name: '',
                profile_image_url: '',
                bio: '',
            },
            showUserEditModal: false,
            selectedMessage: '', // Holds the message to be viewed
            showMessageModal: false, // Controls the visibility of the message modal
            composeReplyModal: {
                show: false,
                message: '',
                replyMessage: '',
                email: ''
            },
            newService: {
                name: '',
                description: '',
                price: null,
                duration: null,
                service_type: 'standard',
                donation_percentage: null
            },
            selectedService: {},
            imagePreview: null,
            selectedCharity: {},
            newCharity: {},
            selectedPayment: {},
            selectedBooking: {},
            selectedDonation: {},
            newLocation: {},
            selectedLocation: {},
            newAvailability: {},
            newExclusionDate: {},
            newRule: {
                dayOfWeek: null,
                startTime: '',
                endTime: '',
                // Add more properties as needed
            },
            editedRule: {
                id: null, // Add the rule ID if available
                dayOfWeek: null,
                startTime: '',
                endTime: '',
                priority: null,
                isRecurring: null,
                newExclusionDate: '', // Vue.js data property for the new exclusion date
                availableDaysOfWeek: [], // Vue.js data property for available days of the week
                excludedDays: [], // Vue.js data property for days to be disabled
            },
            countries: [],
        },
        
        watch: {
            activeTab(newTab, oldTab) {
                this.updateUrl(newTab);
            }
        },
        
        mounted() {
            this.setActiveTabFromUrl();
            this.populateCountries();
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    this.users = data.users;
                    this.userCount = data.users.length; // Dynamically set the user count
                })
                .catch(error => console.error('Error:', error));

            fetch('/api/services')
                .then(response => response.json())
                .then(data => {
                    this.services = data.services.map(service => {
                        return {
                            ...service,
                            image_url: '/static/' + service.image_url, // Adjust the path accordingly
                        };
                    });
                    this.serviceCount = this.services.length; // Dynamically set the service count
                })
                .catch(error => console.error('Error:', error));

            fetch('/api/bookings')
                .then(response => response.json())
                .then(data => {
                    this.bookings = data.bookings;
                    this.bookingCount = data.bookings.length; // Dynamically set the booking count
                })
                .catch(error => console.error('Error:', error));
            
            fetch('/api/donations')
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    this.donations = data.donations;
                    this.donationCount = data.donations.length; // Dynamically set the donation count
                })
                .catch(error => console.error('Error:', error));
            
            fetch('/api/charities')
                .then(response => response.json())
                .then(data => {
                    this.charities = data.charities.map(charity => {
                        return {
                            ...charity,
                            image_url: '/static/' + charity.image_url, // Adjust the path accordingly
                        };
                    });
                })
                .catch(error => console.error('Error:', error));

            fetch('/api/locations')
                .then(response => response.json())
                .then(data => {
                    this.locations = data.locations;
                })
                .catch(error => console.error('Error:', error));

            fetch('/api/payments')
                .then(response => response.json())
                .then(data => {
                    this.payments = data.payments;
                })
                .catch(error => console.error('Error:', error));

            fetch('/api/availabilities')
                .then(response => response.json())
                .then(data => {
                    this.availabilityRules = data.availability_rules.map(rule => {
                        rule.start_time = this.formatTime(rule.start_time);
                        rule.end_time = this.formatTime(rule.end_time);
                        rule.exclusion_dates = rule.exclusion_dates.map(dateStr => {
                            // Remove the time component for exclusion dates
                            const dateWithoutTime = new Date(dateStr);
                            dateWithoutTime.setHours(0, 0, 0, 0);
                            return dateWithoutTime.toLocaleDateString(); // Use toLocaleDateString to get only the date part
                        });
                        return rule;
                    });
                })
                .catch(error => console.error('Error:', error));



            fetch('/api/contact_messages')
                .then(response => response.json())
                .then(data => {
                    this.contactMessages = data.contact_messages;
                })
                .catch(error => console.error('Error:', error));

            fetch('/api/contact_messages')
                .then(response => response.json())
                .then(data => {
                    this.contactMessages = data.contact_messages;
                })
                .catch(error => console.error('Error:', error));
        },
        
        computed: {  
            formattedLatestSignups() {
                return this.data.latest_signups.all().map(user => ({
                    id: user.id,
                    username: user.username,
                    signup_date: this.formatDate(user.signup_date)
                }));
            }
        },
        
        methods: {
            async populateCountries() {
                try {
                    const response = await fetch("https://restcountries.com/v3.1/all");
                    const data = await response.json();
                    this.countries = data.sort((a, b) => {
                        return a.name.common.localeCompare(b.name.common);
                    }).map(country => {
                        return {
                            name: country.name.common,
                            code: country.cca2
                        };
                    });
                } catch (error) {
                    console.error("Error fetching countries:", error);
                }
            },
            
            showAddExclusionDateDialog(availability) {
                // Assuming you're using Bootstrap, you can trigger the modal using jQuery
                $('#addDateModal').modal('show');

                // Set the available days of the week based on the selected rule
                this.availableDaysOfWeek = [availability.day_of_week];
            },
           
            saveNewExclusionDate() {
                // Logic to save the new exclusion date
                // Access the value from this.newExclusionDate and make necessary backend calls
                // You may use a library like Axios for HTTP requests
                axios.post(`/api/exclusion-dates/${availability.id}`, {
                    date: this.newExclusionDate,
                })
                .then(response => {
                    // Handle success, update the UI or perform any other necessary actions
                    console.log('Exclusion date added successfully');

                    // Optionally, reset the form field or close the modal
                    this.newExclusionDate = '';
                    $('#addDateModal').modal('hide');
                })
                .catch(error => {
                    // Handle error, show a message to the user or log the error
                    console.error('Error adding exclusion date:', error);
                });
            },

            showAddExclusionDateDialog(availability) {
                // Assuming you're using Bootstrap, you can trigger the modal using jQuery
                $('#addDateModal').modal('show');
            },

            saveNewExclusionDate() {
                // Logic to save the new exclusion date
                // Access the value from this.newExclusionDate and make necessary backend calls
                // You may use a library like Axios for HTTP requests
                axios.post(`/api/exclusion-dates/${availability.id}`, {
                    date: this.newExclusionDate,
                })
                .then(response => {
                    // Handle success, update the UI or perform any other necessary actions
                    console.log('Exclusion date added successfully');

                    // Optionally, reset the form field or close the modal
                    this.newExclusionDate = '';
                    $('#addDateModal').modal('hide');
                })
                .catch(error => {
                    // Handle error, show a message to the user or log the error
                    console.error('Error adding exclusion date:', error);
                });
            },

            editAvailability(availability) {
                // Populate the editedRule with the selected rule's data
                this.editedRule = {
                    id: availability.id,
                    dayOfWeek: availability.day_of_week,
                    startTime: availability.start_time,
                    endTime: availability.end_time,
                    priority: availability.priority,
                    isRecurring: availability.is_recurring.toString(), // Convert boolean to string
                };

                // Assuming you're using Bootstrap, you can trigger the modal using jQuery
                $('#editRuleModal').modal('show');
            },

            saveEditedRule() {
                // Logic to save the edited rule
                // Access the values from this.editedRule and make necessary backend calls
                // You may use a library like Axios for HTTP requests
                axios.put(`/api/availabilities/${this.editedRule.id}`, {
                    day_of_week: this.editedRule.dayOfWeek,
                    start_time: this.editedRule.startTime,
                    end_time: this.editedRule.endTime,
                    priority: this.editedRule.priority,
                    is_recurring: this.editedRule.isRecurring,
                })
                .then(response => {
                    // Handle success, update the UI or perform any other necessary actions
                    console.log('Rule edited successfully');

                    // Optionally, reset the form fields or close the modal
                    this.editedRule = {
                        id: null,
                        dayOfWeek: null,
                        startTime: '',
                        endTime: '',
                        priority: null,
                        isRecurring: null,
                    };
                    $('#editRuleModal').modal('hide');
                })
                .catch(error => {
                    // Handle error, show a message to the user or log the error
                    console.error('Error editing rule:', error);
                });
            },

            showAddRuleModal() {
                // Assuming you're using Bootstrap, you can trigger the modal using jQuery
                $('#addRuleModal').modal('show');
                // Add any additional logic needed for initialization
            },

            addNewAvailabilityRule() {
                // Logic to add a new availability rule
                // Access the values from this.newRule and make necessary backend calls
                // You may use a library like Axios for HTTP requests
                axios.post('/api/availabilities', {
                    day_of_week: this.newRule.dayOfWeek,
                    start_time: this.newRule.startTime,
                    end_time: this.newRule.endTime,
                    // Include other properties as needed
                })
                .then(response => {
                    // Handle success, update the UI or perform any other necessary actions
                    console.log('New availability rule added successfully');

                    // Optionally, reset the form fields or close the modal
                    this.newRule = {
                        dayOfWeek: null,
                        startTime: '',
                        endTime: '',
                        // Reset other properties as needed
                    };
                    $('#addRuleModal').modal('hide');
                })
                .catch(error => {
                    // Handle error, show a message to the user or log the error
                    console.error('Error adding new availability rule:', error);
                });
            },

            saveNewExclusionDate() {
                // Logic to save the new exclusion date
                // Access the value from this.newExclusionDate and make necessary backend calls
                // You may use a library like Axios for HTTP requests
                axios.post('/api/exclusion-date', {
                    availability_rule_id: this.selectedAvailability.id,
                    date: this.newExclusionDate,
                })
                .then(response => {
                    // Handle success, update the UI or perform any other necessary actions
                    console.log('Exclusion date added successfully');
                    
                    // Optionally, reset the form field or close the modal
                    this.newExclusionDate = '';
                    $('#addDateModal').modal('hide');
                })
                .catch(error => {
                    // Handle error, show a message to the user or log the error
                    console.error('Error adding exclusion date:', error);
                });
            },
            
            showAddExclusionDateDialog(availability) {
                // Assuming you're using Bootstrap, you can trigger the modal using jQuery
                $('#addDateModal').modal('show');
                // Add any additional logic needed for initialization based on the availability parameter
            },

            DeleteRule(ruleId) {
                // Logic to confirm and delete the availability rule
                const confirmDelete = confirm('Are you sure you want to delete this rule?');
                
                if (confirmDelete) {
                    // Make a call to the backend to delete the rule based on ruleId
                    // You may use a library like Axios for HTTP requests
                    axios.delete(`/api/availability-rule/${ruleId}`)
                        .then(response => {
                            // Handle success, update the UI or perform any other necessary actions
                            console.log('Rule deleted successfully');
                        })
                        .catch(error => {
                            // Handle error, show a message to the user or log the error
                            console.error('Error deleting rule:', error);
                        });
                }
            },

            RemoveExclusionDate(availability, date) {
                // Logic to confirm and remove the exclusion date
                const confirmRemove = confirm('Are you sure you want to remove this exclusion date?');
                
                if (confirmRemove) {
                    // Make a call to the backend to remove the exclusion date
                    // You may use a library like Axios for HTTP requests
                    axios.delete(`/api/exclusion-date/${availability.id}/${date}`)
                        .then(response => {
                            // Handle success, update the UI or perform any other necessary actions
                            console.log('Exclusion date removed successfully');
                        })
                        .catch(error => {
                            // Handle error, show a message to the user or log the error
                            console.error('Error removing exclusion date:', error);
                        });
                }
            },

            // Helper method to reset the form fields for adding a new rule
            resetNewRuleForm() {
                this.newRuleDayOfWeek = ''; // Reset other form fields similarly
                // Optionally, close the modal or perform any other necessary actions
            },
            
            deleteService(service) {
                // Prompt the user for confirmation (you can use a library or a custom modal)
                const confirmed = confirm("Are you sure you want to delete this service?");
                
                if (confirmed) {
                    // Call the API to delete the service
                    axios.delete(`/api/services/${service.id}`)
                        .then(response => {
                            // Handle success
                            console.log(response.data.message);
                            // Optionally, update the service list or perform any necessary actions
                        })
                        .catch(error => {
                            // Handle error
                            console.error("Error deleting service:", error);
                        });
                }
            },
            
            confirmBooking(bookingId) {
                // Implement logic to confirm the booking
                const confirmed = confirm("Are you sure you want to confirm this booking?");

                if (confirmed) {
                    // Call the API to confirm the booking
                    axios.put(`/api/bookings/${bookingId}/confirm`)
                        .then(response => {
                            // Handle success
                            console.log(response.data.message);
                            // Optionally, update the booking list or perform any necessary actions
                        })
                        .catch(error => {
                            // Handle error
                            console.error("Error confirming booking:", error);
                        });
                }
            },
            
            viewLocation(location) {
                // Set selectedLocation in your data to the clicked location
                this.selectedLocation = location;
                // Show the viewLocationModal
                $('#viewLocationModal').modal('show');
            },
            
            editLocation(location) {
                // Set selectedLocation in your data to the clicked location
                this.selectedLocation = location;
                // Show the editLocationModal
                $('#editLocationModal').modal('show');
            },
            
            deleteLocation(location) {
                // Set selectedLocation in your data to the clicked location
                this.selectedLocation = location;
                // Show the deleteLocationModal
                $('#deleteLocationModal').modal('show');
            },
            
            confirmDeleteLocation() {
                // Call the API to delete the location
                axios.delete(`/api/locations/${this.selectedLocation.id}`)
                    .then(response => {
                        // Handle success
                        console.log(response.data.message);
                        // Optionally, update the location list or perform any necessary actions
                        // Close the modal
                        $('#deleteLocationModal').modal('hide');
                    })
                    .catch(error => {
                        // Handle error
                        console.error("Error deleting location:", error);
                    });
            },
            
            updateLocation() {
                // Validate the edited location data (you can add more validation if needed)

                // Call the API to update the location
                axios.put(`/api/locations/${this.selectedLocation.id}`, this.selectedLocation)
                    .then(response => {
                        // Handle success
                        console.log(response.data.message);
                        // Optionally, update the location list or perform any necessary actions
                        // Close the modal
                        $('#editLocationModal').modal('hide');
                    })
                    .catch(error => {
                        // Handle error
                        console.error("Error updating location:", error);
                    });
            },
            
            saveLocation() {
                // Validate the new location data (you can add more validation if needed)

                // Call the API to add the new location
                axios.post('/api/locations', this.newLocation)
                    .then(response => {
                        // Handle success
                        console.log(response.data.message);
                        // Optionally, update the location list or perform any necessary actions
                        // Clear the form and close the modal
                        this.newLocation = {};
                        $('#addLocationModal').modal('hide');
                    })
                    .catch(error => {
                        // Handle error
                        console.error("Error adding new location:", error);
                    });
            },
            
            addLocation() {
                // Implement logic to show a modal or redirect to a page for adding a new location
                // Example: $('#addLocationModal').modal('show');
                // or router.push('/add-location');
                this.newLocation = {};
                $('#addLocationModal').modal('show');
            },
            
            showViewDonationModal(donation) {
                // Implement logic to handle the "View" modal
                // You can set the selectedDonation data property and show the modal
                // Example: this.selectedDonation = donation;
                // Example: $('#viewDonationModal').modal('show');
                this.selectedDonation = donation;

                $('#viewDonationModal').modal('show');
            },
            
            showViewBookingModal(booking) {
                // Set the selectedBooking data property to the provided booking
                this.selectedBooking = booking;

                // Show the "View Booking" modal using jQuery
                $('#viewBookingModal').modal('show');
            },
            
            showPaymentDetails(payment) {
                // Set the selectedPayment data property
                this.selectedPayment = payment;
                // Trigger the modal to show
                $('#viewPaymentModal').modal('show');
            },
            
            charityImagePreview() {},
            
            addNewCharity() {
                // Validate the new charity data (you can add more validation if needed)

                // Call the API to add the new charity
                axios.post('/api/charities', this.newCharity)
                    .then(response => {
                        // Handle success
                        console.log(response.data.message);
                        // Optionally, update the charity list or perform any necessary actions
                        // Clear the form and close the modal
                        this.newCharity = {};
                        $('#addCharityModal').modal('hide');
                    })
                    .catch(error => {
                        // Handle error
                        console.error("Error adding new charity:", error);
                    });
            },
            
            handleCharityImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    // Use FileReader to read the selected file and update the preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Assuming `editedCharityImage` is a data property in your component
                        this.editedCharityImage = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },
            
            editedCharityImage() {},
            
            handleCharityImageUpload() {},
            
            openViewCharityDetailsModal(charity) {
                // Set the selected charity for displaying details
                this.selectedCharity = charity;
                // Open the "View Details" modal
                $('#viewDetailsModal').modal('show');
            },
            
            openEditCharityModal(charity) {
                // Set the selected charity for editing
                this.selectedCharity = { ...charity };
                // Open the "Edit Charity" modal
                $('#editCharityModal').modal('show');
            },
            
            saveCharityChanges() {
                // Validate the edited charity data (you can add more validation if needed)

                // Call the API to update the charity
                axios.put(`/api/charities/${this.selectedCharity.id}`, this.selectedCharity)
                    .then(response => {
                        // Handle success
                        console.log(response.data.message);
                        // Optionally, update the charity list or perform any necessary actions
                        // Close the modal
                        $('#editCharityModal').modal('hide');
                    })
                    .catch(error => {
                        // Handle error
                        console.error("Error saving charity changes:", error);
                    });
            },
            
            deleteCharity(charityId) {
                // Confirm before deleting
                const confirmed = confirm("Are you sure you want to delete this charity?");

                if (confirmed) {
                    // Call the API to delete the charity
                    axios.delete(`/api/charities/${charityId}`)
                        .then(response => {
                            // Handle success
                            console.log(response.data.message);
                            // Optionally, update the charity list or perform any necessary actions
                        })
                        .catch(error => {
                            // Handle error
                            console.error("Error deleting charity:", error);
                        });
                }
                $('#editCharityModal').modal('hide');
            },
            
            showServiceInfoModal(service) {
                // Set the selectedService for displaying in the Info modal
                this.selectedService = service;
                // Open the Info modal
                $('#infoServiceModal').modal('show');
            },

            showEditServiceModal(service) {
                // Set the selectedService for editing in the Edit modal
                this.selectedService = service;
                // Open the Edit modal
                $('#editServiceModal').modal('show');
            },

            saveServiceChanges() {
                // Assuming you have initialized the selectedService object in your data
                // Make sure to initialize it in your data() with the necessary fields
                // selectedService: {
                //     id: 0,
                //     name: '',
                //     description: '',
                //     duration: 0,
                //     price: 0,
                //     service_type: 'standard',
                //     donation_percentage: 0,
                //     image_url: '',
                //     // Add other fields as needed
                // }

                // Create FormData for the file upload
                const formData = new FormData();
                formData.append('name', this.selectedService.name);
                formData.append('description', this.selectedService.description);
                formData.append('duration', this.selectedService.duration);
                formData.append('price', this.selectedService.price);
                formData.append('service_type', this.selectedService.service_type);
                formData.append('donation_percentage', this.selectedService.donation_percentage);
                formData.append('image', this.selectedService.image);  // Assuming 'image' is the file input in your form

                // Make API call to update the service using fetch
                fetch(`/api/services/${this.selectedService.id}`, {
                    method: 'PUT',
                    body: formData,
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Service updated successfully:', data);
                    // Optionally update your Vue data or take any other necessary action
                    // Close the modal or update the service list, etc.
                    $('#editServiceModal').modal('hide');
                })
                .catch(error => {
                    console.error('Error updating service:', error);
                    // Log the entire error object for more details
                    // Handle the error as needed
                });
            },

            addNewService() {
                // Assuming you have initialized the newService object in your data
                // Make sure to initialize it in your data() as an empty object
                // newService: {
                //     name: '',
                //     description: '',
                //     duration: 0,
                //     price: 0,
                //     service_type: 'standard',
                //     donation_percentage: 0,
                //     image: null,  // Assuming you will store the image file here
                // }

                // Create FormData for the file upload
                const formData = new FormData();
                formData.append('name', this.newService.name);
                formData.append('description', this.newService.description);
                formData.append('duration', this.newService.duration);
                formData.append('price', this.newService.price);
                formData.append('service_type', this.newService.service_type);
                formData.append('donation_percentage', this.newService.donation_percentage);
                formData.append('image', this.newService.image);  // Assuming 'image' is the file input in your form

                // Make API call to add the new service using fetch
                fetch('/api/services', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Service added successfully:', data);
                    // Optionally update your Vue data or take any other necessary action
                    // Clear the form or close the modal, etc.
                    $('#addServiceModal').modal('hide');
                })
                .catch(error => {
                    console.error('Error adding service:', error);
                    // Log the entire error object for more details
                    // Handle the error as needed
                });
            },

            viewUserDetails(user) {
                // Set the selected user and show the modal
                this.selectedUser = user;
                $('#userDetailsModal').modal('show');
            },

            initiateReply(message) {
                this.composeReplyModal.message = message;
                this.composeReplyModal.email = message.email;
                this.composeReplyModal.show = true;
                $('#composeReplyModal').modal('show');
            },

            deleteMessage(messageId) {
                // Call the API endpoint to delete the message
                fetch(`/api/contact_messages/${messageId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        // Handle success or show an alert to the user
                        console.log(data.message);
                        // Refresh the contact messages list
                        this.refreshContactMessages();
                    })
                    .catch(error => console.error('Error:', error));
            },

            refreshContactMessages() {
                fetch('/api/contact_messages')
                    .then(response => response.json())
                    .then(data => {
                        this.contactMessages = data.contact_messages;
                    })
                    .catch(error => console.error('Error:', error));
            },

            closeComposeReplyModal() {
                // Close the modal and reset the reply message
                this.composeReplyModal.show = false;
                this.composeReplyModal.message = null;
                this.composeReplyModal.replyMessage = '';
            },

            sendReply() {
                // Call the API endpoint to send the reply
                const messageId = this.composeReplyModal.message.id;
                const replyMessage = this.composeReplyModal.replyMessage;
                const userEmail = this.composeReplyModal.email;

                fetch(`/api/contact_messages/${messageId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reply_message: replyMessage, email: userEmail }),
                })
                    .then(response => response.json())
                    .then(data => {
                        // Handle success or show an alert to the user
                        console.log(data.message);
                        // Close the modal and reset the reply message
                        this.closeComposeReplyModal();
                        // Refresh the contact messages list
                        this.refreshContactMessages();
                    })
                    .catch(error => console.error('Error:', error));
            },
            
            viewFullMessage(message) {
                this.selectedMessage = message; // Set the selected message
                this.showMessageModal = true; // Show the modal
                $('#viewMessageModal').modal('show');
            },
            
            changeTab(tabName) {
                this.activeTab = tabName;
            },
            
            updateUrl(tabName) {
                const newUrl = window.location.protocol + '//' + window.location.host + window.location.pathname + '?tab=' + tabName;
                window.history.pushState({ path: newUrl }, '', newUrl);
            },
            
            setActiveTabFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const tabParam = urlParams.get('tab');
                if (tabParam && this.isTabValid(tabParam)) {
                    this.activeTab = tabParam;
                }
            },
            
            isTabValid(tabName) {
                const validTabs = ['statistics', 'users', 'services', 'bookings', 'donations', 'charities', 'locations', 'payments', 'availabilities', 'contactMessages'];
                return validTabs.includes(tabName);
            },
            
            redirectTo(url) {
                window.location.href = url;
            },

            formatDateTime(datetimeStr) {
                if (!datetimeStr) return '';
                const date = new Date(datetimeStr);
                return date.toLocaleString(); // You can customize the format as needed
            },
            
            formatCurrency(amount) {
                if (amount === null || amount === undefined) return '';
                // Format the amount as currency
                // The 'en-US' locale is used as an example, adjust as per your requirement
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
            },
            
            truncateMessage(message, maxLength = 100) {
                if (!message) return '';
                if (message.length <= maxLength) return message;
                return message.substring(0, maxLength) + '...';
            },
            
            editUser(user) {
                this.selectedUser = { ...user }; // Clone the user object
                console.log(this.selectedUser);
                $('#userEditModal').modal('show');
            },
            
            handleImageUpload(event) {
                // Get the selected file from the input
                const file = event.target.files[0];


                // Log the file to check if it's present
                console.log('Selected File:', file);


                // Update the image preview onscreen
                const imagePreview = document.getElementById('imagePreview');
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    // If no file selected, show the default image
                    imagePreview.src = 'https://jonathanksullivan.github.io/prophet-yani/image/default_profile.webp';
                }

                // Update the selectedUser with the file
                if (file) {
                    this.selectedUser.profileImage = file;
                }
            },

            updateUser() {
                // Implement the logic to update the user
                console.log('Updating user:', this.selectedUser);

                // Make API call to update the user using fetch
                fetch(`/api/users/${this.selectedUser.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: this.selectedUser,
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('User updated successfully:', data);
                    // Optionally update your Vue data or take any other necessary action
                    $('#userEditModal').modal('hide');
                })
                .catch(error => {
                    console.error('Error updating user:', error);
                    // Log the entire error object for more details
                    // Handle the error as needed
                });
            },

            formatDayOfWeek(dayOfWeek) {
                // Implement the formatting logic here
                // For example, you can return the full name of the day
                const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                return daysOfWeek[dayOfWeek];
            },
            
            formatDate(date) {
                if (!date) return '';
                return new Date(date).toLocaleDateString(); // Adjust the date format as needed
            },
            
            formatTime(time) {
                if (!time || time === 'Invalid Date') return ''; // Handle the case when time is undefined, null, or 'Invalid Date'

                // Split the time string into hours, minutes, and seconds
                const [hours, minutes, seconds] = time.split(':');

                // Create a new Date object with the current date and the extracted time components
                const formattedTime = new Date();
                formattedTime.setHours(parseInt(hours));
                formattedTime.setMinutes(parseInt(minutes));
                formattedTime.setSeconds(parseInt(seconds));

                if (isNaN(formattedTime.getTime())) {
                    return ''; // Handle invalid time
                }

                // Format the time as HH:mm for input type="time"
                const formattedHours = String(formattedTime.getHours()).padStart(2, '0');
                const formattedMinutes = String(formattedTime.getMinutes()).padStart(2, '0');

                return `${formattedHours}:${formattedMinutes}`;
            }
        },
    });
</script>
{% endblock %}

{% extends "base.html" %}

{% block head %}
<style>
    /* Custom styles for the profile page */
    .profile-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 0;
    }
    .profile-header h2 {
        font-weight: bold;
        color: #333;
    }
    .non-editable-field {
        background-color: #e9ecef;
        padding: 0.5rem;
        border: none;
        border-radius: 0.25rem;
    }
    .profile-image {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 1rem;
    }
</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
{% endblock %}

{% block header %}
<div class="profile-header">
    <div class="container">
        <h2 class="text-center">Your Profile</h2>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 text-center">
            <!-- Profile Image -->
            <img src="{{ user.profile_image_url if user.profile_image_url else 'https://jonathanksullivan.github.io/prophet-yani/image/default_profile.webp' }}" alt="Profile Image" class="profile-image">
            <!-- Display any flash messages here -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endwith %}
            <form method="POST" action="{{ url_for('user_blueprint.profile') }}" enctype="multipart/form-data">
                <!-- Profile Information -->
                <div class="form-group">
                    <label for="profile_image">Profile Image</label>
                    <input type="file" class="form-control-file" id="profile_image" name="profile_image">
                </div>
                <div class="form-group">
                    <label for="username">Username</label>
                    <div class="non-editable-field">{{ user.username }}</div>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <div class="non-editable-field">{{ user.email }}</div>
                </div>
                <div class="form-group">
                    <label for="first_name">First Name</label>
                    <input type="text" class="form-control" id="first_name" name="first_name" value="{{ user.first_name }}">
                </div>
                <div class="form-group">
                    <label for="last_name">Last Name</label>
                    <input type="text" class="form-control" id="last_name" name="last_name" value="{{ user.last_name }}">
                </div>
                <div class="form-group">
                    <label for="bio">Bio</label>
                    <textarea class="form-control" id="bio" name="bio">{{ user.bio }}</textarea>
                </div>

                <!-- Location Information -->
                <h3 class="mt-4">Location Information</h3>
                <div class="form-group">
                    <label for="country">Country</label>
                    <select class="form-control" id="country" name="country">
                        <!-- Countries will be populated here -->
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" name="action" value="update_profile">Update Profile</button>
            </form>

            <!-- Password Change Form -->
            <form method="POST" action="{{ url_for('user_blueprint.profile') }}" class="mt-3">
                <h3>Change Password</h3>
                <div class="form-group">
                    <label for="new_password">New Password</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="new_password" name="new_password" required>
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="fas fa-eye"></i> <!-- Font Awesome Eye Icon -->
                            </button>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" name="action" value="change_password">Update Password</button>
            </form>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
    // Function to fetch and populate countries
    function populateCountries() {
        var currentUserCountry = "{{ user.country }}";

        $.ajax({
            url: "https://restcountries.com/v3.1/all",
            dataType: "json",
            success: function(data) {
                data.sort(function(a, b) {
                    return a.name.common.localeCompare(b.name.common);
                });

                $('#country').empty();
                $('#country').append(new Option('Select Country', ''));
                data.forEach(function(country) {
                    var option = new Option(country.name.common, country.cca2);
                    $('#country').append(option);
                    if (country.name.common === currentUserCountry) {
                        $('#country').val(country.cca2);
                    }
                });
                $('#country').select2();
            }
        });
    }

    // Toggle Password Visibility
    document.getElementById('togglePassword').addEventListener('click', function (e) {
        // Toggle the type attribute
        const password = document.getElementById('new_password');
        const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
        password.setAttribute('type', type);

        // Toggle the eye / eye-slash icon
        this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });

    populateCountries();
</script>
{% endblock %}
